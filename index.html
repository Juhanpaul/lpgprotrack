<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LPG Monitoring System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f4f8;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      background-color: white;
      margin-top: 30px;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 500px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    button {
      padding: 10px 20px;
      margin: 10px 0;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .status {
      margin: 15px 0;
      font-size: 16px;
      color: #555;
    }
    .alert {
      color: red;
      font-weight: bold;
    }
    .warning {
      color: orange;
    }
    .safe {
      color: green;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>LPG Monitoring System</h1>
    <button onclick="connectBluetooth()">Connect Bluetooth</button>
    <div class="status" id="deviceName">Device: Not connected</div>
    <div class="status" id="weightDisplay">Weight: -- kg</div>
    <div class="status" id="percentageDisplay">LPG Remaining: --%</div>
    <div class="status" id="leakStatus">Leak Status: --</div>
    <button onclick="setTareWeight()">Set Tare Weight (Empty Cylinder)</button>
    <button onclick="generatePDF()">Generate PDF Report</button>
  </div>

  <script>
    let tareWeight = 0;
    let fullWeight = 14.2; // Default full cylinder weight
    let device;
    let characteristic;

    async function connectBluetooth() {
      try {
        const options = {
          filters: [
            { namePrefix: "HC" },
            { namePrefix: "ESP" }
          ],
          optionalServices: ['battery_service', 'device_information']
        };

        device = await navigator.bluetooth.requestDevice(options);
        document.getElementById('deviceName').textContent = `Device: ${device.name || "Unnamed Device"}`;
        // Simulating connection logic
        console.log("Connected to:", device.name);

        // Simulate receiving data every 5 seconds
        setInterval(mockReceiveData, 5000);
      } catch (error) {
        console.error("Bluetooth connection failed:", error);
      }
    }

    function setTareWeight() {
      tareWeight = prompt("Enter current weight as tare (empty cylinder):");
      tareWeight = parseFloat(tareWeight);
      if (!isNaN(tareWeight)) {
        alert(`Tare weight set to ${tareWeight} kg`);
      } else {
        alert("Invalid input");
      }
    }

    function mockReceiveData() {
      // Simulating random weight and gas detection values
      const rawWeight = Math.random() * fullWeight; // random weight
      const gasDetected = Math.random() < 0.1; // 10% chance of leak

      const netWeight = rawWeight - tareWeight;
      const percentage = Math.max(0, Math.min(100, (netWeight / fullWeight) * 100));

      document.getElementById('weightDisplay').textContent = `Weight: ${netWeight.toFixed(2)} kg`;
      document.getElementById('percentageDisplay').textContent = `LPG Remaining: ${percentage.toFixed(0)}%`;

      let statusEl = document.getElementById('leakStatus');
      if (gasDetected) {
        statusEl.textContent = "Leak Status: Gas Leak Detected!";
        statusEl.className = 'status alert';
      } else if (percentage < 5) {
        statusEl.textContent = "Leak Status: Gas less than 5%!";
        statusEl.className = 'status alert';
      } else if (percentage < 15) {
        statusEl.textContent = "Leak Status: Gas less than 15%";
        statusEl.className = 'status warning';
      } else if (percentage < 30) {
        statusEl.textContent = "Leak Status: Gas less than 30%";
        statusEl.className = 'status warning';
      } else {
        statusEl.textContent = "Leak Status: Safe";
        statusEl.className = 'status safe';
      }
    }

    function generatePDF() {
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("LPG Monitoring Report", 20, 20);
      doc.setFontSize(12);

      const device = document.getElementById('deviceName').textContent;
      const weight = document.getElementById('weightDisplay').textContent;
      const percentage = document.getElementById('percentageDisplay').textContent;
      const status = document.getElementById('leakStatus').textContent;

      doc.text(device, 20, 40);
      doc.text(weight, 20, 50);
      doc.text(percentage, 20, 60);
      doc.text(status, 20, 70);

      doc.save("LPG_Report.pdf");
    }
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
