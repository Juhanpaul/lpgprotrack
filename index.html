<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPG Monitoring System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .status-card {
            margin: 20px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: #f1f1f1;
        }
        .status-card.connected {
            background-color: #4CAF50;
            color: white;
        }
        .status-card.disconnected {
            background-color: #FF6347;
            color: white;
        }
        .button {
            display: block;
            width: 100%;
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        .button:hover {
            background-color: #0056b3;
        }
        select {
            width: 100%;
            padding: 10px;
            margin-top: 20px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .hidden {
            display: none;
        }
        #gasInfo {
            font-size: 18px;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>LPG Monitoring System</h1>
    <div class="status-card disconnected" id="connectionStatus">
        <h3>Bluetooth Status: Disconnected</h3>
    </div>

    <button id="connectBtn" class="button" onclick="toggleBluetoothConnection()">Connect Bluetooth</button>

    <select id="deviceList" class="hidden"></select>

    <div id="gasInfo">
        <p>Gas Level: <span id="gasLevel">100%</span></p>
        <p>Weight: <span id="weight">Full</span></p>
    </div>

    <button id="pdfBtn" class="button" onclick="generatePDF()">Generate PDF</button>
</div>

<script>
    const connectionStatus = document.getElementById('connectionStatus');
    const connectBtn = document.getElementById('connectBtn');
    const deviceList = document.getElementById('deviceList');
    const gasLevelDisplay = document.getElementById('gasLevel');
    const weightDisplay = document.getElementById('weight');

    let state = {
        server: null,
        device: null,
        characteristic: null,
        gasLevel: 100, // Example gas level
        weight: 'Full', // Example weight description
        connectionTime: null
    };

    // Bluetooth Functions
    async function toggleBluetoothConnection() {
        if (state.server) {
            await disconnectBluetooth();
        } else {
            await connectBluetooth();
        }
    }

    async function connectBluetooth() {
        try {
            // Request Bluetooth device and specify the filter (show names)
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,  // Accept all devices
                optionalServices: ['generic_access'],  // Optional Bluetooth services
            });

            // If device found, display name in the dropdown
            if (device) {
                const option = document.createElement("option");
                option.value = device.name;
                option.textContent = device.name || 'Unknown Device';
                deviceList.appendChild(option);

                // Show the device list and connect to it
                deviceList.classList.remove("hidden");

                // Connect to the first device (for simplicity)
                state.device = device;
                state.server = await state.device.gatt.connect();
                connectionStatus.className = 'status-card connected';
                connectionStatus.querySelector('h3').textContent = `Bluetooth Status: Connected to ${state.device.name}`;
                connectBtn.textContent = 'Disconnect';
                state.connectionTime = new Date();
                startSimulatedData();
            }

        } catch (error) {
            console.error('Bluetooth error:', error);
            alert(`Bluetooth connection failed: ${error}`);
        }
    }

    async function disconnectBluetooth() {
        if (state.server) {
            await state.server.disconnect();
            state.server = null;
            state.device = null;
        }
        connectionStatus.className = 'status-card disconnected';
        connectionStatus.querySelector('h3').textContent = 'Bluetooth Status: Disconnected';
        connectBtn.textContent = 'Connect Bluetooth';
        stopSimulatedData();
    }

    // Simulating the LPG gas and weight updates (for demo purposes)
    function startSimulatedData() {
        setInterval(() => {
            // Simulate gas level decreasing over time
            if (state.gasLevel > 5) {
                state.gasLevel -= 1;
            }
            gasLevelDisplay.textContent = `${state.gasLevel}%`;

            // Simulate weight decrease
            if (state.gasLevel <= 30) {
                weightDisplay.textContent = 'Low';
            } else if (state.gasLevel <= 15) {
                weightDisplay.textContent = 'Critical';
            }
        }, 1000);
    }

    function stopSimulatedData() {
        clearInterval(startSimulatedData);
    }

    // PDF Generation Function
    function generatePDF() {
        const doc = new jsPDF();
        doc.text(`LPG Monitoring Report`, 20, 20);
        doc.text(`Gas Level: ${state.gasLevel}%`, 20, 30);
        doc.text(`Weight: ${weightDisplay.textContent}`, 20, 40);
        doc.save('lpg-report.pdf');
    }

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
